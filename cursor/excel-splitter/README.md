# Excel Splitter

一个用于拆分Excel表格中工资数据的工具，根据工时表对工资进行按比例拆分。

## 功能说明

该工具用于处理工资数据，主要功能包括：

1. 根据工时表对工资进行按比例拆分
2. 保持源表格的格式和样式
3. 支持自定义配置的列映射和拆分规则

## 配置说明

配置文件采用YAML格式，默认文件名为`config.yaml`。配置项说明如下：

```yaml
input:
  path: "input/项目成本.xlsx"  # 输入文件路径
  sheet:
    source:
      name: "工资"  # 源数据表名
      columns:  # 源数据列映射
        employee_id: "工号"
        project_id: "费用所属中心"
        project_category: "费用类别"
        project_hours: "实际出勤"
    reference:
      name: "工时"  # 参考数据表名
      columns:  # 参考数据列映射
        employee_id: "工号"
        project_id: "费用所属中心"
        project_category: "费用类别"
        project_hours: "实际出勤"
  splitting_columns:  # 需要拆分的列
  - 基本工资
  - 岗位工资
output:
  path: "output/项目成本拆分.xlsx"  # 输出文件路径
  sheet:
    result:
      name: "工资拆分"  # 结果表名
```

## 数据验证规则

1. 源数据表(source)验证：
   - 必须包含`employee_id`列
   - 必须包含`splitting_columns`中定义的所有列
   - `project_hours`列可选

2. 参考数据表(reference)验证：
   - 必须包含`employee_id`列
   - 必须包含`project_id`列
   - 必须包含`project_category`列
   - 必须包含`project_hours`列

## 拆分规则

1. 以源数据表(source)为基础，参考工时表(reference)进行拆分
2. 结果表(result)与源数据表的列名和顺序完全相同
3. 通过`employee_id`（工号）进行左连接匹配：
   - 如果找到匹配记录：
     - 更新`project_id`、`project_category`、`project_hours`列的内容
     - 对`splitting_columns`中定义的列按`project_hours`比例进行拆分
     - 其他列保持源数据不变
   - 如果未找到匹配记录：
     - 直接复制源数据行到结果表

## 使用说明

1. 准备配置文件`config.yaml`
2. 准备输入Excel文件，确保包含必要的sheet和列
3. 运行程序：
   ```bash
   python main.py [--config config.yaml]
   ```

## 测试用例

### 1. 表头一致性测试

验证结果表的表头与源数据表完全一致。

```markdown
表source:
| 姓名 | 工号 | 部门   | 基本工资  | 岗位工资  | 费用类别 | 费用所属中心 | 实际出勤 | 分管领导 |
|------|------|--------|-----------|-----------|----------|--------------|----------|----------|

表result:
| 姓名 | 工号 | 部门   | 基本工资  | 岗位工资 | 费用类别 | 费用所属中心 | 实际出勤 | 分管领导 |
|------|------|--------|-----------|----------|----------|--------------|----------|----------|
```

### 2. 无匹配记录测试

当工号在参考表中无匹配记录时，直接复制源数据行。

```markdown
表source:
| 姓名 | 工号 | 部门   | 基本工资  | 岗位工资  | 费用类别 | 费用所属中心 | 实际出勤 | 分管领导 |
|------|------|--------|-----------|-----------|----------|--------------|----------|----------|
| 张三 | AA   | 中国   | 1000.00   | 3000.00   | 研发     | 研发部       | 21       | BB       |

表result:
| 姓名 | 工号 | 部门   | 基本工资  | 岗位工资 | 费用类别 | 费用所属中心 | 实际出勤 | 分管领导 |
|------|------|--------|-----------|----------|----------|--------------|----------|----------|
| 张三 | AA   | 中国   | 1000.00   | 3000.00   | 研发     | 研发部       | 21       | BB       |
```

### 3. 工资拆分测试

当工号在参考表中有匹配记录时，按工时比例拆分工资。

```markdown
表source:
| 姓名 | 工号 | 部门   | 基本工资  | 岗位工资  | 费用类别 | 费用所属中心 | 实际出勤 | 分管领导 |
|------|------|--------|-----------|-----------|----------|--------------|----------|----------|
| 张三 | AA   | 中国   | 1000.00   | 3000.00   | 研发     | 研发部       | 21       | BB       |

表reference:
| 姓名 | 工号 | 费用类别 | 费用所属中心 | 实际出勤 |
|------|------|----------|--------------|----------|
| 张三 | AA   | 研发     | 1            | 1        |
| 张三 | AA   | 研发     | 2            | 4        |
| 张三 | AA   | 销售     | 3            | 4        |

表result:
| 姓名 | 工号 | 部门   | 基本工资  | 岗位工资 | 费用类别 | 费用所属中心 | 实际出勤 | 分管领导 |
|------|------|--------|-----------|----------|----------|--------------|----------|----------|
| 张三 | AA   | 中国   | 111.11    | 333.33   | 研发     | 1            | 1        | BB       |
| 张三 | AA   | 中国   | 444.44    | 1333.33  | 研发     | 2            | 4        | BB       |
| 张三 | AA   | 中国   | 444.44    | 1333.33  | 销售     | 3            | 4        | BB       |
```

## 运行测试

```bash
python -m unittest test_excel_splitter.py
```

## 注意事项

1. 所有文件编码采用UTF-8
2. 输入文件必须符合数据验证规则
3. 拆分比例基于参考表中的总工时计算
4. 结果表保持源数据表的格式和样式

## 项目结构

```
excel-splitter/
├── input/              # 输入文件目录
├── output/             # 输出文件目录
├── main.py            # 主程序
├── test_main.py       # 单元测试
├── config.yaml        # 配置文件
├── requirements.txt   # 项目依赖
└── README.md         # 项目文档
```

## 依赖

- Python 3.6+
- openpyxl
- pyyaml
- pytest (用于测试)

## 错误处理

- 如果输入文件不存在，程序会报错并退出
- 如果源表不存在，程序会报错并退出
- 所有错误信息都会打印到控制台 